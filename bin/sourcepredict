#!/usr/bin/env python

import argparse
from sourcepredictlib.forest import sourceforest
from sourcepredictlib import utils


def _get_args():
    '''This function parses and return arguments passed in'''
    parser = argparse.ArgumentParser(
        prog='SourcePredict v' + str(version),
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description=f'''
==========================================================
SourcePredict v{version}
Coprolite source classification
Author: Maxime Borry
Contact: <borry[at]shh.mpg.de>
Homepage & Documentation: github.com/maxibor/sourcepredict
==========================================================
        ''')
    parser.add_argument('otu_table', help="path to otu table in csv format")
    parser.add_argument(
        '-a',
        dest="alpha",
        default=0.1,
        help="Proportion of sink sample in unknown. Default = 0.1")
    parser.add_argument(
        '-s',
        dest="sources",
        default='./data/dog_human_pig_sources.csv',
        help="Path to source csv file. Default = ./data/dog_human_pig_sources.csv")
    parser.add_argument(
        '-r',
        dest="ratio",
        default='human',
        help="Target organism for ratio calculation. Default = 'human'")
    parser.add_argument(
        '-n',
        dest="normalization",
        default='Subsample',
        help="Normalization method (RLE | CLR | Subsample). Default = Subsample")
    parser.add_argument(
        '-o',
        dest="output",
        default=None,
        help="Output file basename. Default = sourcepredict_output.csv")
    parser.add_argument(
        '-se',
        dest="seed",
        default=None,
        help="Seed for random generator. Default = None (randomly generated)")
    parser.add_argument(
        '-t',
        dest="threads",
        default=2,
        help="Number of threads for parallel processing. Default = 2")

    args = parser.parse_args()

    sink = args.otu_table
    alpha = args.alpha
    normalization = args.normalization
    ratio = args.ratio
    sources = args.sources
    seed = args.seed
    output = args.output
    threads = int(args.threads)

    return(sink, alpha, normalization, sources, ratio, seed, output, threads)


if __name__ == "__main__":
    version = "0.1"
    SINK, ALPHA, NORMALIZATION, SOURCES, RATIO, SEED, OUTPUT, THREADS = _get_args()
    SEED = utils.check_gen_seed(SEED)
    NORMALIZATION = utils.check_norm(NORMALIZATION)
    a = sourceforest(source=SOURCES, sink=SINK)
    a.add_unknown(alpha=ALPHA)
    a.normalize(method=NORMALIZATION)
    a.rndForest(seed=SEED, threads=THREADS, ratio=RATIO)
    with open(OUTPUT, 'w') as o:
        o.write(str(a.comp_ratio))
